// Code Export Utilities
// Export generated code to files and project structures

use serde::{Deserialize, Serialize};

/// Export format
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ExportFormat {
    SingleFile,
    ProjectStructure,
    Makefile,
    CMake,
    PlatformIO,
}

/// Export result
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ExportResult {
    pub success: bool,
    pub files_created: Vec<String>,
    pub error: Option<String>,
}

/// Generate CMakeLists.txt for exported project
pub fn generate_cmake(project_name: &str, sources: &[&str], mcu: &str) -> String {
    let sources_list = sources.iter()
        .map(|s| format!("    {}", s))
        .collect::<Vec<_>>()
        .join("\n");
    
    format!(r#"# CMakeLists.txt
# Generated by NeuroBench

cmake_minimum_required(VERSION 3.20)
set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 17)

project({project_name} C CXX ASM)

# MCU Configuration
set(MCU "{mcu}")

# Source files
set(SOURCES
{sources}
)

# Include directories
include_directories(
    ${{CMAKE_SOURCE_DIR}}/Inc
    ${{CMAKE_SOURCE_DIR}}/Drivers/CMSIS/Include
    ${{CMAKE_SOURCE_DIR}}/Drivers/CMSIS/Device/ST/STM32F4xx/Include
    ${{CMAKE_SOURCE_DIR}}/Drivers/STM32F4xx_HAL_Driver/Inc
)

# Compiler flags
set(CMAKE_C_FLAGS "${{CMAKE_C_FLAGS}} -mcpu=cortex-m4 -mthumb -mfpu=fpv4-sp-d16 -mfloat-abi=hard")
set(CMAKE_C_FLAGS "${{CMAKE_C_FLAGS}} -ffunction-sections -fdata-sections -Wall")

# Linker flags
set(CMAKE_EXE_LINKER_FLAGS "${{CMAKE_EXE_LINKER_FLAGS}} -T${{CMAKE_SOURCE_DIR}}/STM32F407VGTx_FLASH.ld")
set(CMAKE_EXE_LINKER_FLAGS "${{CMAKE_EXE_LINKER_FLAGS}} -Wl,--gc-sections -Wl,-Map=${{PROJECT_NAME}}.map")

add_executable(${{PROJECT_NAME}}.elf ${{SOURCES}})

# Post-build: generate .bin and .hex
add_custom_command(TARGET ${{PROJECT_NAME}}.elf POST_BUILD
    COMMAND arm-none-eabi-objcopy -O binary ${{PROJECT_NAME}}.elf ${{PROJECT_NAME}}.bin
    COMMAND arm-none-eabi-objcopy -O ihex ${{PROJECT_NAME}}.elf ${{PROJECT_NAME}}.hex
    COMMAND arm-none-eabi-size ${{PROJECT_NAME}}.elf
)
"#,
        project_name = project_name,
        mcu = mcu,
        sources = sources_list,
    )
}

/// Generate Makefile for exported project
pub fn generate_makefile(project_name: &str, sources: &[&str], mcu: &str) -> String {
    let sources_list = sources.iter()
        .map(|s| format!("    {} \\", s))
        .collect::<Vec<_>>()
        .join("\n");
    
    format!(r#"# Makefile
# Generated by NeuroBench

PROJECT = {project_name}
MCU = {mcu}

# Toolchain
CC = arm-none-eabi-gcc
OBJCOPY = arm-none-eabi-objcopy
SIZE = arm-none-eabi-size

# Flags
CFLAGS = -mcpu=cortex-m4 -mthumb -mfpu=fpv4-sp-d16 -mfloat-abi=hard
CFLAGS += -ffunction-sections -fdata-sections -Wall -O2
CFLAGS += -DSTM32F407xx -DUSE_HAL_DRIVER
CFLAGS += -IInc -IDrivers/CMSIS/Include -IDrivers/STM32F4xx_HAL_Driver/Inc

LDFLAGS = -T STM32F407VGTx_FLASH.ld
LDFLAGS += -Wl,--gc-sections -Wl,-Map=$(PROJECT).map
LDFLAGS += -specs=nano.specs -specs=nosys.specs

# Sources
SOURCES = \
{sources}

# Objects
OBJECTS = $(SOURCES:.c=.o)

.PHONY: all clean flash

all: $(PROJECT).elf $(PROJECT).bin $(PROJECT).hex

$(PROJECT).elf: $(OBJECTS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^
	$(SIZE) $@

$(PROJECT).bin: $(PROJECT).elf
	$(OBJCOPY) -O binary $< $@

$(PROJECT).hex: $(PROJECT).elf
	$(OBJCOPY) -O ihex $< $@

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

clean:
	rm -f $(OBJECTS) $(PROJECT).elf $(PROJECT).bin $(PROJECT).hex $(PROJECT).map

flash: $(PROJECT).bin
	st-flash write $(PROJECT).bin 0x8000000
"#,
        project_name = project_name,
        mcu = mcu,
        sources = sources_list,
    )
}

/// Generate PlatformIO configuration
pub fn generate_platformio_ini(project_name: &str, board: &str, framework: &str) -> String {
    format!(r#"; PlatformIO Project Configuration File
; Generated by NeuroBench

[env:{project_name}]
platform = ststm32
board = {board}
framework = {framework}

; Build settings
build_flags =
    -DUSE_HAL_DRIVER
    -DSTM32F407xx
    -Wall
    -O2

; Debug settings
debug_tool = stlink
debug_init_break = tbreak main

; Upload settings
upload_protocol = stlink

; Monitor settings
monitor_speed = 115200
"#,
        project_name = project_name,
        board = board,
        framework = framework,
    )
}

/// Generate project structure directories
pub fn get_project_structure() -> Vec<&'static str> {
    vec![
        "Src",
        "Inc",
        "Drivers",
        "Drivers/CMSIS",
        "Drivers/CMSIS/Include",
        "Drivers/STM32F4xx_HAL_Driver",
        "Drivers/STM32F4xx_HAL_Driver/Inc",
        "Drivers/STM32F4xx_HAL_Driver/Src",
        "Startup",
        "Linker",
    ]
}

/// Generate main.c template
pub fn generate_main_c(includes: &[&str], init_calls: &[&str]) -> String {
    let includes_str = includes.iter()
        .map(|i| format!("#include \"{}\"", i))
        .collect::<Vec<_>>()
        .join("\n");
    
    let init_calls_str = init_calls.iter()
        .map(|c| format!("    {}();", c))
        .collect::<Vec<_>>()
        .join("\n");

    format!(r#"/**
 * @file main.c
 * @brief Main application entry point
 * @generated NeuroBench
 */

#include "main.h"
{includes}

int main(void) {{
    // HAL initialization
    HAL_Init();
    
    // System clock configuration
    SystemClock_Config();
    
    // Peripheral initialization
{init_calls}
    
    // Main loop
    while (1) {{
        // Application code here
    }}
}}

void Error_Handler(void) {{
    __disable_irq();
    while (1) {{
    }}
}}

#ifdef USE_FULL_ASSERT
void assert_failed(uint8_t *file, uint32_t line) {{
    // User can add own implementation
}}
#endif
"#,
        includes = includes_str,
        init_calls = init_calls_str,
    )
}

/// Generate header file template
pub fn generate_header(name: &str, content: &str) -> String {
    let guard = name.to_uppercase().replace('.', "_");
    
    format!(r#"/**
 * @file {name}
 * @brief Generated by NeuroBench
 */

#ifndef {guard}
#define {guard}

#ifdef __cplusplus
extern "C" {{
#endif

{content}

#ifdef __cplusplus
}}
#endif

#endif /* {guard} */
"#,
        name = name,
        guard = guard,
        content = content,
    )
}
